{
  "title": "VDI Core Service Config Schema",
  "$schema": "https://json-schema.org/draft-07/schema",

  "definitions": {

    "port": {
      "type": "integer",
      "minimum": 1,
      "maximum": 65535
    },

    "queueSettings": {
      "type": "object",
      "properties": {
        "host": {
          "description": "Hostname of the RabbitMQ instance.",
          "type": "string",
          "format": "hostname"
        },
        "port": {
          "description": "Port to use when connecting to RabbitMQ.",
          "$ref": "#/definitions/port",
          "default": 5672
        },
        "user": {
          "description": "RabbitMQ username.",
          "type": [ "string", "null" ],
          "default": null
        },
        "pass": {
          "description": "RabbitMQ password.",
          "type": [ "string", "null" ],
          "default": null
        },
        "queue": {
          "description": "RabbitMQ queue name.",
          "type": "string"
        }
      },
      "required": [
        "host",
        "queue"
      ]
    },

    "postgresDatabase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "host": {
          "type": "string",
          "format": "hostname"
        },
        "port": {
          "$ref": "#/definitions/port",
          "default": 5432
        },
        "database": {
          "type": "string"
        },
        "user": {
          "type": "string"
        },
        "pass": {
          "type": "string"
        },
        "poolSize": {
          "type": "integer",
          "minimum": 1,
          "maximum": 20,
          "default": 5
        }
      },
      "required": [
        "host",
        "database",
        "user",
        "pass"
      ]
    },

    "applicationDatabase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "ldap": {
          "description": "LDAP query to use to retrieve the connection details for the target database.",
          "type": "string"
        },
        "user": {
          "description": "Database connection username",
          "type": "string"
        },
        "pass": {
          "description": "Database connection password",
          "type": "string"
        }
      },
      "required": [
        "ldap",
        "user",
        "pass"
      ]
    }
  },

  "type": "object",

  "properties": {

    "web-server": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "port": {
          "$ref": "#/definitions/port",
          "default": 80
        },
        "enable-trace-headers": {
          "type": "boolean",
          "default": false
        }
      }
    },

    "service": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "enable-email-sending": {
          "type": "boolean"
        },

        "support-email-address": {
          "type": "string",
          "format": "email"
        },

        "workers": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "import-event-handler-count": {
              "type": "integer",
              "minimum": 1,
              "maximum": 20
            },
            "datastore-event-handler-count": {
              "type": "integer",
              "minimum": 1,
              "maximum": 20
            },
            "action-event-handler-count": {
              "type": "integer",
              "minimum": 1,
              "maximum": 20
            }
          },
          "required": [
            "import-event-handler-count",
            "datastore-event-handler-count",
            "action-event-handler-count"
          ]
        }
      },
      "required": [
        "enable-email-sending",
        "support-email-address",
        "workers"
      ]
    },


    "connections": {
      "type": "object",
      "properties": {
        "ldap": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "servers": {
              "type": "array",
              "minItems": 1,
              "uniqueItems": true,
              "items": {
                "type": "string"
              }
            },
            "base-dn": {
              "type": "string"
            }
          },
          "required": [
            "servers",
            "base-dn"
          ]
        },

        "handler": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "host": {
              "type": "string",
              "format": "hostname"
            },
            "port": {
              "$ref": "#/definitions/port",
              "default": 80
            }
          },
          "required": [
            "host"
          ]
        },
        "smtp": {
          "type": "object",
          "properties": {
            "host": {
              "type": "string",
              "format": "hostname"
            },
            "port": {
              "type": "integer",
              "minimum": 1,
              "maximum": 65535,
              "default": 25
            }
            // TODO: fill this out
          },
          "required": [
            "host"
            // TODO: fill this out
          ]
        },
        "queues": {
          "type": "object",
          "properties": {
            "datastore": { "$ref": "#/definitions/queueSettings" },
            "import": { "$ref": "#/definitions/queueSettings" },
            "action": { "$ref": "#/definitions/queueSettings" }
          },
          "required": [
            "datastore",
            "import",
            "action"
          ]
        },
        "postgres": { "$ref": "#/definitions/postgresDatabase" },
        "application-databases": {
          "type": "object",
          "additionalProperties": { "$ref": "#/definitions/applicationDatabase" },
          "minProperties": 1
        }
      },
      "additionalProperties": false,
      "required": [
        "handler",
        "smtp",
        "queues",
        "postgres",
        "application-databases"
      ]
    }
  },
  "additionalProperties": false,
  "required": [
    "connections",
    "web-server",
    "service"
  ]
}
