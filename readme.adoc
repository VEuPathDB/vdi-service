= VEuPathDB Dataset Installer Service (VDI)
:source-highlighter: highlightjs
:toc:

:confluence: https://veupathdb.atlassian.net/wiki/spaces

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

ifndef::env-github[]
:icons: font
endif::[]


== Documentation Links

=== API

==== Production

* link:https://veupathdb.github.io/vdi-service/prod/vdi-api.html[REST Service API Doc]
//* Configuration Schema Doc
//* Full Configuration Schema
//* Configuration Schema Root


==== QA

* link:https://veupathdb.github.io/vdi-service/qa/vdi-api.html[REST Service API Doc]
//* Configuration Schema Doc
//* Full Configuration Schema
//* Configuration Schema Root


==== Dev

* link:https://veupathdb.github.io/vdi-service/dev/vdi-api.html[REST Service API Doc]
* link:https://veupathdb.github.io/vdi-service/dev/schema/data/dataset-characteristics.eda.json[EDA Dataset Characteristics Schema]
* link:https://veupathdb.github.io/vdi-service/dev/schema/data/dataset-characteristics.genomics.json[Genomics Dataset Characteristics Schema]
* link:https://veupathdb.github.io/vdi-service/dev/schema/data/dataset-characteristics.metaschema.json[Dataset Characteristiscs Metaschema]


=== Administration

.Confluence
* link:{confluence}/TECH/folder/1006829569[Administration Docs Folder]
* link:{confluence}/TECH/pages/1006698498/Purge+Broken+Dataset+Folders+from+MinIO[Purge Broken Datasets from Object Store]
* link:{confluence}/TECH/pages/1283817474/Handling+Failed+Dataset+Installs[Handling Failed Dataset Installs]
* link:{confluence}/UI/pages/553680929/VDI+User+and+Administration+Guide[User and General Admin Guide]

=== Deployment & Configuration

* link:https://veupathdb.github.io/vdi-service/dev/config-schema.html[Configuration Schema Doc]
* link:https://veupathdb.github.io/vdi-service/dev/schema/config/full-config.json[Full Configuration Schema]
* link:https://veupathdb.github.io/vdi-service/dev/schema/config/stack-config.json[Configuration Schema Root]


=== Design

.Document Links
[%collapsible]
====
Initial Design::
+
--
* link:docs/outdated/overview/overview.html[Original Overview]
--

Feature Expansion::
+
--
* link:{confluence}/UI/pages/1292599331/VDI+Feature+Dataset+Data+Revisioning[Dataset Revisioning]
--
====


== Development

=== Running the Stack Locally

==== Configure Compose Environment

Copy the `./compose/example.local.env` file into the project root with the name
`.env`.

[source, shell]
----
cp compose/example.local.env .env
----

Edit the `.env` file and fill in the required variable values.

===== Optional: Select Image Versions

If specific docker image versions are desired for running a test, additional
environment variables may be added to the `.env` file to specify image versions.

If no image version is specified for an image, `latest` will be assumed.

.Image Env Vars
[%collapsible]
====
[source, dotenv]
----
VDI_CACHE_DB_TAG=latest
VDI_KAFKA_TAG=latest

VDI_SERVICE_TAG=latest

VDI_PLUGIN_BIGWIG_TAG=latest
VDI_PLUGIN_BIOM_TAG=latest
VDI_PLUGIN_EXAMPLE_TAG=latest
VDI_PLUGIN_GENELIST_TAG=latest
VDI_PLUGIN_ISASIMPLE_TAG=latest
VDI_PLUGIN_NOOP_TAG=latest
VDI_PLUGIN_WRANGLER_TAG=latest
VDI_PLUGIN_RNASEQ_TAG=latest
----
====

==== Start the Service Stack

The full service stack can be started and managed locally by using available
`make` commands for stack management.

Initial Startup & Image Redeploy::
Use if the stack has never been run, has been previously destroyed via
`compose-down`, or to deploy rebuilt images (may be performed without stopping
the stack).
+
[source, shell]
----
make compose-up
----

Shutdown & Destroy Stack::
Erases volumes and container state.
+
[source, shell]
----
make compose-down
----

Halt Stack::
Maintains volumes and container state.
+
[source, shell]
----
make compose-stop
----

Restart Halted Stack::
+
[source, shell]
----
make compose-start
----


===== Optional: Build Local Changes

If local code changes have been made, and you wish to test those changes in the
container stack, a new image may be built using the `make` target `build-image`.

[source, shell]
----
make build-image
----

This build target requires the environment variables `GITHUB_USERNAME` and
`GITHUB_TOKEN` be available in the running shell.  See the
{confluence}/TECH/pages/108560402/Deploy+Containerized+Services+for+Local+Development[Confluence Container Guide]
for additional information.


== Repo Structure

The VDI service repository root directory contains subdirectories for source
code, configuration, documentation, and deployment related files.  Most
development tasks will be performed in the subprojects under the `./service`
directory.

=== Project Source

The `./service` directory contains the VDI service source code and compiled Jar
contents.

A generally important detail about the project that makes the division of
subprojects here more easily understandable is that the VDI container service is
not a single application, but is actually 11 independent, self-contained
applications running on a single JVM.

The `./service` directory is divided up by category:

[cols="2,8"]
|===
| link:service/bootstrap/[`bootstrap`]
| Contains the root 'Main' class that is called when executing the compiled jar.
This project is responsible for starting up the component processes that make up
the VDI container service.

| link:service/lib/[`lib`]
| Contains shared code used by multiple component sub-applications.

| link:service/module/[`module`]
| Contains the source for the individual component sub-applications that make up
the VDI container service.

| link:service/schema/[`schema`]
| Contains the JSON schema definitions for dataset metadata and the service
configuration files.

| link:service/gradle/[`gradle`]
| Contains the Gradle dependency catalogue declaring the dependency versions for
all libraries used by all VDI service sub-projects.

| link:service/buildSrc/[`buildSrc`]
| Source for gradle build extensions that are complex enough to warrant their
own class and/or source file.
|===


[NOTE]
Gradle tasks may be executed from this directory directly without the `:service`
prefix that is required for tasks executed from the project root.

=== Service Components

==== Lanes

Dataset event handlers.  Each lane is a separate process that subscribes to a
Kafka channel and operates on datasets whose information is provided in the
incoming events.

* link:service/module/lane/hard-delete/[Hard Delete]
* link:service/module/lane/import/[Import]
* link:service/module/lane/install/[Install Data]
* link:service/module/lane/reconciliation/[Reconciliation]
* link:service/module/lane/sharing/[Share]
* link:service/module/lane/soft-delete/[Soft Delete]
* link:service/module/lane/update-meta/[Update Meta]

==== Rest Service

The rest service is the public API through which users and administrators
communicate with and operate on the VDI system.

* link:service/module/rest-service/[Rest API Service]

==== Daemons

Independent background tasks.

* link:service/module/daemon/event-router/[MinIO Event Router]
* link:service/module/daemon/pruner/[Stale Object Pruner]
* link:service/module/daemon/reconciler/[Dataset Reconciler]

==== Bootstrapper

The bootstrapper is responsible for starting up the service modules listed above
and ensuring a full JVM shutdown if any service module crashes.

* link:service/bootstrap/[Bootstrapper]

=== Internal Libs

.link:service/lib/dataset/[Dataset Management]
* link:service/lib/dataset/pruner[Dataset Pruner Implementation]
* link:service/lib/dataset/reconciler/[Dataset Reconciler Implementation]
* link:service/lib/dataset/reinstaller/[Dataset Reinstaller]

.link:service/lib/db/[Database Interaction]
* link:service/lib/db/application/[Application DB Client]
* link:service/lib/db/internal/[Internal DB Client]
* link:service/lib/db/common/[Shared DB Components]

.link:service/lib/plugin/[Plugin Communication]
* link:service/lib/plugin/client[Plugin HTTP Client]
* link:service/lib/plugin/registry/[Enabled Plugin Mapping]

.link:service/lib/external[External Service APIs]
* link:service/lib/external/kafka[Kafka Client]
* link:service/lib/external/ldap[LDAP Utilities]
* link:service/lib/external/rabbit[Rabbit Client]
* link:service/lib/external/s3[MinIO Dataset Management Wrapper]

.Misc
* link:service/lib/async/[Async Utilities]
* link:service/lib/common/[Universal Components]
* link:service/lib/config/[Dumb Service Config POJOs]
* link:service/lib/install-target/[Dataset Install Target Registry]
* link:service/lib/module-core/[Service/Module Core API]
* link:service/lib/test-utils[Unit Test Utilities]


== VDI Project Repository Links

.Services
* https://github.com/VEuPathDB/vdi-service[VDI Core Service]
* https://github.com/VEuPathDB/vdi-plugin-handler-server[VDI Plugin Handler Service]

.Plugins
* https://github.com/VEuPathDB/vdi-plugin-bigwig[bigWig]
* https://github.com/VEuPathDB/vdi-plugin-biom[BIOM]
* https://github.com/VEuPathDB/vdi-plugin-genelist[Gene List]
* https://github.com/VEuPathDB/vdi-plugin-isasimple[ISA Study]
* https://github.com/VEuPathDB/vdi-plugin-noop[NoOp]
* https://github.com/VEuPathDB/vdi-plugin-wrangler[Phenotype]
* https://github.com/VEuPathDB/vdi-plugin-rnaseq[RNA-Seq]

.Docker Images
* https://github.com/VEuPathDB/vdi-internal-db[Cache DB Docker Image]
* https://github.com/VEuPathDB/docker-gus-apidb-base[Gus/ApiDB Schema Base] +
[.small]#_Not explicitly part of VDI, but the base image for several plugins_#

.Service Libraries
* https://github.com/VEuPathDB/vdi-component-common[Commons Library]
* https://github.com/VEuPathDB/vdi-component-json[JSON Utilities]

.Plugin Libraries
* https://github.com/VEuPathDB/lib-vdi-plugin-rnaseq[lib-rnaseq]
* https://github.com/VEuPathDB/lib-vdi-plugin-study[lib-study]

.Misc
* https://github.com/VEuPathDB/vdi-plugin-example[Example Plugin]
* https://github.com/VEuPathDB/VdiSchema[VDI App DB Schema]
c
